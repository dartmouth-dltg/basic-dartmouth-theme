# gulp-build

A common Gulp configuration that can be used to build minified CSS and
Javascript from SASS, CSS and Javascript source files.

[[_TOC_]]

## Prerequisites

 * nodejs version 16 or higher
 * access to the gulp-build registry (see below)

## Preinstallation setup: Access to the gulp-build registry

Gulp-build is packaged and stored in the Library's Gitlab registry
under the scope `@dltg` and named `@dltg/gulp-build`.  Complete
details on using the Gitlab registry are found
[here](https://docs.gitlab.com/ee/user/packages/npm_registry/).  Here
is a summary specific to this project.  You will require a personal
access token with scope `api`.  Also note the project ID for
dltg/gulp-build is 432 as found on the project's home page in Gitlab.

1.  Set the npm registry configuration:

 `npm config set @dltg:registry
 https://gitlab.library.dartmouth.edu/api/v4/projects/432/packages/npm/`

2. Add your access token to enable access to the registry via the API:

 `npm config set --
 '//gitlab.library.dartmouth.edu/api/v4/projects/432/packages/npm/:_authToken'
 "<your_token>"`

(Note: This configuration is saved privately in ~/.npmrc, and may be
edited there if needed, for example, to update the authToken.)

## Installation

To install the package in a new working directory of a project that
already contains gulp-build, run `npm install`.

## Adding to a project

1. Configure registry access (see above).

2. Add gulp-build to the project's package list: `npm add @dltg/gulp-build`.

3. Create a gulpfile.js for the project.  A minimal gulpfile.js which
   reads configuration from `gulp-config.js` and exports all the
   methods defined by gulp-build is shown below.

```
const $conf = require('./gulp-config.js');
const $build = require('@dltg/gulp-build')($conf);

module.exports = $build;
```

4. Configure gulp-build.  This is typically done with a gulp-config.js
   file as described below.

5. Add an `.eslintrc.json` and `.stylelintrc.json` to the root of your
   project.  gulp-build contains reference copies of these files which
   you may copy and modify or symlink directly.  To symlink them into
   a project:

```
ln -s node_modules/@dltg/gulp-build/templates/eslintrc.json .eslintrc.json
ln -s node_modules/@dltg/gulp-build/templates/stylelintrc.json .stylelintrc.json
```

   Carefully note the use of leading periods.

## Tasks

To run any gulp task, use `npx gulp <task>`.  Available tasks can be
listed by running `npx gulp --tasks`.  The tasks are described below.

  * **clean** -- remove all Gulp build products.
  
  * **build** -- lint and process all SASS, CSS and Javascript source files
    and update the source file checksums.  Equivalent to performing in
    order: clean, sass, js, cat, and minify and then updating the
    source checksums.
    ```mermaid
    graph TD;
      A[clean] --> B(sass);
      A --> C(js);
      A --> D(cat);
      A --> E(update source checksums);
      
      B --> F(minify);
      C --> F;
      D --> F;
      E --> F;
    ```
  
  *  **ubuild** -- lint and process all SASS, CSS and Javascript source files 
    and update the source file checksums without minification. Equivalent to performing 
    in order: clean, sass, js, cat and then updating the source checksums.

  * **default** -- an alias for "build", executed by running `npx gulp`
    with no specific task given.
    
  * **watch** -- monitor source files and rebuild products if they change.
    Reload the browserSync URL after rebuilding.
    
  * **cat** -- perform the CSS concatenation steps
  
  * **sass** -- lint and compile the SASS files to produce CSS sources
  
  * **jsLint** -- lint the Javascript sources
  
  * **js** -- uglify the Javascript sources
  
  * **gulpJsLint** -- lint the Gulp configuration and Javascript files.
  
  * **composerJsonLint** -- lint the project's composer.json file.
  
  * **minify** -- minify the CSS sources


## Configuring

Configuration for gulp-build is passed to the module during
initialization as properties of an object.  Typically the object is
defined in a gulp-config.js file and loaded by a project's gulpfile.js
prior to loading gulp-build.  A basic gulp-config.js with an empty configuration looks like this:

```
module.exports = {};
```

The top level of the configuration contains 5 major sections:

* browserSync
* gulp
* product
* sass
* css
* js

Each section is described below.

### browserSync

This section contains the configuration for the "sync" function.  It
has one element, `proxyTarget`, which defines the URL which should be
reloaded when a resource changes.

### gulp

This section defines properties of the project's gulp environment.  It
has one element, `files` which defines an array of glob patterns
matching the files involved in the gulp script of the project.  These
patterns identify the files validated by the `gulpJsLint` task.
A typical project will have a gulpfile.js and gulp-config.js file in
this list:

```
gulp: { files: ["./gulpfile.js", "./gulp-config.js"] }
```

### product

This section defines methods for identifying the products of the gulp
operations.  It contains these elements:

  * dirs -- an array of directory glob patterns that contain build products.
    These directories are deleted when the `clean` task is executed.
    
  * files -- an array of glob patterns matching the build products of
    the gulp tasks.  These files are deleted when the `clean` task is
    executed.  These files are also watched by the `watch` operation
    and trigger a browser reload when they change.
    
  * checksums -- a directory into which source file checksums are
    written when a build is performed.  These checksums can be used to
    determine if the products are out of date with the sources.  If
    this entry is omitted, no checksums are generated during a build.

### sass

This section defines the sass files that are processed into CSS by a
build.  If this section is omitted, no SASS processing is done.  It
contains these elements:

  * sources -- an array of glob patterns matching the SCSS files to be
    processed. 
  
  * destination -- the directory path into which the CSS products are
    written.  Directory paths beginning with "." are relative to the
    corresponding SCSS file.

### css

This section describes processing of CSS files, including those
produced from SASS. CSS processing is handled in 2 stages:
concatenation, and minification.  Lists of CSS files to be
concatenated are assembled, then individual CSS files are minified to
a final destination. The elements of the css section are:

  * concatenate -- an array of two element objects defining the
    concatenation operation.  If this section is omitted, no
    concatenated products are produced.  The elements are:
    
    * sources -- an array of glob patterns matching the files to
      concatenate together.
    
    * destination -- the file produced by the concatenation.
  
  * sources -- an array of Glob patterns matching the CSS files to be
    minified.  If any of the concatenation products are to be
    minified, they must be matched by a sources pattern.  If this
    element is omitted, no minification is performed.
  
  * exclude -- an optional array of glob patterns matching already
    minified CSS.  If the sources patterns matches existing minified
    files, this pattern can be used to exclude those files to prevent
    unnecessary minification.
  
  * destination -- a directory into which the minified files and
    corresponding map files will be written.  If the path begins with
    "." the path is relative to the directory containing the
    corresponding CSS file.

### js

This section defines parameters for performing operations on
Javascript sources.  These sources are passed both to the lint
operation and to Uglify to generate slimmed down Javascript files.  It
contains the following elements:

  * sources - an array of Glob patterns matching the Javascript files
    to be processed.  If this element is omitted, no Javascript
    processing is performed.
  
  * destination - a directory in which the uglified output are placed.

## Updating the gulp-build npm package

To publish an updated version of the gulp-build package:

1. Configure registry access as described above.

2. Update the version number of the package inside the project's
   package.json file.  (Gitlab will not allow you to build a package
   with an existing version.  You can delete an existing version and
   rebuild it, but this is not recommended as standard practice.)

3. Run `npm publish`.

